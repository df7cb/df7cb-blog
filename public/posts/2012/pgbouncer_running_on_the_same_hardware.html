<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>pgbouncer running on the same hardware | Myon&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="We have a PostgreSQL server with 16 cores that was apparently running well
below its capacity: load something between 3.0 and 4.0, around 200 active
database connections, almost all always being &lt;IDLE&gt;. However, when the
tps count reached 7k transactions per second, things started to throttle, and
pgbouncer (running on the database server) started listing up to half of the
client connections to be in cl_waiting state. Load was still low, but
application performance was bad.

The culprit turned out to be the kernel scheduler, fairly distributing CPU time
among all running processes. There&rsquo;s one single pgbouncer process, but hundreds
of postgres processes.
A simple renice of the pgbouncer process did the trick and gave us another
extra 2k tps.">
    <meta name="generator" content="Hugo 0.152.2">
    
    
    
      <meta name="robots" content="index, follow">
    
    <meta name="author" content="Christoph Berg">
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.efe4d852f731d5d1fbb87718387202a97aafd768cdcdaed0662bbe6982e91824.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://df7cb.de/blog/posts/2012/pgbouncer_running_on_the_same_hardware.html">
    

    <meta property="og:url" content="https://df7cb.de/blog/posts/2012/pgbouncer_running_on_the_same_hardware.html">
  <meta property="og:site_name" content="Myon&#39;s Blog">
  <meta property="og:title" content="pgbouncer running on the same hardware">
  <meta property="og:description" content="We have a PostgreSQL server with 16 cores that was apparently running well below its capacity: load something between 3.0 and 4.0, around 200 active database connections, almost all always being &lt;IDLE&gt;. However, when the tps count reached 7k transactions per second, things started to throttle, and pgbouncer (running on the database server) started listing up to half of the client connections to be in cl_waiting state. Load was still low, but application performance was bad.
The culprit turned out to be the kernel scheduler, fairly distributing CPU time among all running processes. There’s one single pgbouncer process, but hundreds of postgres processes.
A simple renice of the pgbouncer process did the trick and gave us another extra 2k tps.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2012-11-30T08:52:40+01:00">
    <meta property="article:modified_time" content="2012-11-30T08:52:40+01:00">
    <meta property="article:tag" content="Debian">
    <meta property="article:tag" content="Postgresql">

  <meta itemprop="name" content="pgbouncer running on the same hardware">
  <meta itemprop="description" content="We have a PostgreSQL server with 16 cores that was apparently running well below its capacity: load something between 3.0 and 4.0, around 200 active database connections, almost all always being &lt;IDLE&gt;. However, when the tps count reached 7k transactions per second, things started to throttle, and pgbouncer (running on the database server) started listing up to half of the client connections to be in cl_waiting state. Load was still low, but application performance was bad.
The culprit turned out to be the kernel scheduler, fairly distributing CPU time among all running processes. There’s one single pgbouncer process, but hundreds of postgres processes.
A simple renice of the pgbouncer process did the trick and gave us another extra 2k tps.">
  <meta itemprop="datePublished" content="2012-11-30T08:52:40+01:00">
  <meta itemprop="dateModified" content="2012-11-30T08:52:40+01:00">
  <meta itemprop="wordCount" content="120">
  <meta itemprop="keywords" content="Debian,Postgresql">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="pgbouncer running on the same hardware">
  <meta name="twitter:description" content="We have a PostgreSQL server with 16 cores that was apparently running well below its capacity: load something between 3.0 and 4.0, around 200 active database connections, almost all always being &lt;IDLE&gt;. However, when the tps count reached 7k transactions per second, things started to throttle, and pgbouncer (running on the database server) started listing up to half of the client connections to be in cl_waiting state. Load was still low, but application performance was bad.
The culprit turned out to be the kernel scheduler, fairly distributing CPU time among all running processes. There’s one single pgbouncer process, but hundreds of postgres processes.
A simple renice of the pgbouncer process did the trick and gave us another extra 2k tps.">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/blog/index.html" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Myon&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">pgbouncer running on the same hardware</h1>
      
      <p class="tracked"><strong>Christoph Berg</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2012-11-30T08:52:40+01:00">November 30, 2012</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>We have a PostgreSQL server with 16 cores that was apparently running well
below its capacity: load something between 3.0 and 4.0, around 200 active
database connections, almost all always being &lt;IDLE&gt;. However, when the
tps count reached 7k transactions per second, things started to throttle, and
pgbouncer (running on the database server) started listing up to half of the
client connections to be in cl_waiting state. Load was still low, but
application performance was bad.</p>
<img src="http://www.df7cb.de/blog/2012/renice_pgbouncer.png">
<p>The culprit turned out to be the kernel scheduler, fairly distributing CPU time
among all running processes. There&rsquo;s one single pgbouncer process, but hundreds
of postgres processes.</p>
<p>A simple <em>renice</em> of the pgbouncer process did the trick and gave us another
extra 2k tps.</p>
<ul class="pa0">
  
   <li class="list di">
     <a href="/blog/tags/debian.html" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Debian</a>
   </li>
  
   <li class="list di">
     <a href="/blog/tags/postgresql.html" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Postgresql</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/posts/2012/shared_memory_and_swapping.html">Shared Memory and Swapping</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/postgresql_in_debian_hackathon.html">PostgreSQL in Debian Hackathon</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/postgresql_in_debian.html">PostgreSQL in Debian</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/grep_-r_foobar.html">grep -r foobar</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/mkfs.ext3_-b_1024.html">mkfs.ext3 -b 1024</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/machine_check_exception.html">Machine Check Exception</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/andreas.html">Andreas</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/usr_bin_time.html">Cool Unix Features: /usr/bin/time</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/how_not_to_edit_files.html">How not to edit files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/generating_symbols_files_from_a_series_of_.deb_files.html">Generating symbols files from a series of .deb files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/tab_completion_in_vim.html">Tab completion in vim</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/kudos_to_dh_python2.html">Kudos to dh_python2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/dlv.html">DLV removes all *.de records</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/marriage_and_baptism.html">Marriage and Baptism</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/hp_2605dn_not_recognizing_new_cartridge.html">HP 2605dn not regcognizing new cartridge</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://df7cb.de/blog/index.html" >
    &copy;  Myon's Blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
