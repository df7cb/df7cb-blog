<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Shared Memory and Swapping | Myon&#39;s Blog</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="We have this PostgreSQL server with plenty of RAM that is still using some of
its swap over the day (up to 600MB). Then suddenly everything is swapped in
again.

It turned out the reason is there are two clusters running, and the second one
isn&rsquo;t used as heavily as the first one. Disk I/O activity of the first cluster
slowly evicts pages from the second shared buffers cache to swap, and then the
daily pg_dump run reads them back every evening.
I was not aware of an easy way to get numbers for &ldquo;amount of SysV shared memory
swapped to disk&rdquo;, but some googling led to shmctl(2):

#define _GNU_SOURCE 1
#include &lt;sys/ipc.h&gt;
#include &lt;sys/shm.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main ()
{
        struct shm_info info;
        int max;
        long PAGE_SIZE = sysconf(_SC_PAGESIZE);

        max = shmctl(0, SHM_INFO, (struct shmid_ds *) &info);
        printf (&#34;max: %d\nshm_tot: %ld\nshm_rss: %ld\nshm_swp: %ld\n&#34;,
                        max,
                        info.shm_tot * PAGE_SIZE,
                        info.shm_rss * PAGE_SIZE,
                        info.shm_swp * PAGE_SIZE);

        return 0;
}

The output looks like this:

max: 13
shm_tot: 13232308224
shm_rss: 12626661376
shm_swp: 601616384

Update: Mark points out that ipcs -mu shows the same information. Thanks for the hint!

# ipcs -mu

------ Shared Memory Status --------
segments allocated 2
pages allocated 3230544
pages resident  3177975
pages swapped   51585
Swap performance: 0 attempts     0 successes
">
    <meta name="generator" content="Hugo 0.152.2">
    
    
    
      <meta name="robots" content="index, follow">
    
    <meta name="author" content="Christoph Berg">
    

    
<link rel="stylesheet" href="/blog/ananke/css/main.min.efe4d852f731d5d1fbb87718387202a97aafd768cdcdaed0662bbe6982e91824.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://df7cb.de/blog/posts/2012/Shared_Memory_and_Swapping.html">
    

    <meta property="og:url" content="https://df7cb.de/blog/posts/2012/Shared_Memory_and_Swapping.html">
  <meta property="og:site_name" content="Myon&#39;s Blog">
  <meta property="og:title" content="Shared Memory and Swapping">
  <meta property="og:description" content="We have this PostgreSQL server with plenty of RAM that is still using some of its swap over the day (up to 600MB). Then suddenly everything is swapped in again.
It turned out the reason is there are two clusters running, and the second one isn’t used as heavily as the first one. Disk I/O activity of the first cluster slowly evicts pages from the second shared buffers cache to swap, and then the daily pg_dump run reads them back every evening.
I was not aware of an easy way to get numbers for “amount of SysV shared memory swapped to disk”, but some googling led to shmctl(2):
#define _GNU_SOURCE 1 #include &lt;sys/ipc.h&gt; #include &lt;sys/shm.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; int main () { struct shm_info info; int max; long PAGE_SIZE = sysconf(_SC_PAGESIZE); max = shmctl(0, SHM_INFO, (struct shmid_ds *) &amp;info); printf (&#34;max: %d\nshm_tot: %ld\nshm_rss: %ld\nshm_swp: %ld\n&#34;, max, info.shm_tot * PAGE_SIZE, info.shm_rss * PAGE_SIZE, info.shm_swp * PAGE_SIZE); return 0; } The output looks like this:
max: 13 shm_tot: 13232308224 shm_rss: 12626661376 shm_swp: 601616384 Update: Mark points out that ipcs -mu shows the same information. Thanks for the hint!
# ipcs -mu ------ Shared Memory Status -------- segments allocated 2 pages allocated 3230544 pages resident 3177975 pages swapped 51585 Swap performance: 0 attempts 0 successes">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2012-11-29T10:23:10+01:00">
    <meta property="article:modified_time" content="2012-11-29T10:23:10+01:00">
    <meta property="article:tag" content="Debian">
    <meta property="article:tag" content="Postgresql">

  <meta itemprop="name" content="Shared Memory and Swapping">
  <meta itemprop="description" content="We have this PostgreSQL server with plenty of RAM that is still using some of its swap over the day (up to 600MB). Then suddenly everything is swapped in again.
It turned out the reason is there are two clusters running, and the second one isn’t used as heavily as the first one. Disk I/O activity of the first cluster slowly evicts pages from the second shared buffers cache to swap, and then the daily pg_dump run reads them back every evening.
I was not aware of an easy way to get numbers for “amount of SysV shared memory swapped to disk”, but some googling led to shmctl(2):
#define _GNU_SOURCE 1 #include &lt;sys/ipc.h&gt; #include &lt;sys/shm.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; int main () { struct shm_info info; int max; long PAGE_SIZE = sysconf(_SC_PAGESIZE); max = shmctl(0, SHM_INFO, (struct shmid_ds *) &amp;info); printf (&#34;max: %d\nshm_tot: %ld\nshm_rss: %ld\nshm_swp: %ld\n&#34;, max, info.shm_tot * PAGE_SIZE, info.shm_rss * PAGE_SIZE, info.shm_swp * PAGE_SIZE); return 0; } The output looks like this:
max: 13 shm_tot: 13232308224 shm_rss: 12626661376 shm_swp: 601616384 Update: Mark points out that ipcs -mu shows the same information. Thanks for the hint!
# ipcs -mu ------ Shared Memory Status -------- segments allocated 2 pages allocated 3230544 pages resident 3177975 pages swapped 51585 Swap performance: 0 attempts 0 successes">
  <meta itemprop="datePublished" content="2012-11-29T10:23:10+01:00">
  <meta itemprop="dateModified" content="2012-11-29T10:23:10+01:00">
  <meta itemprop="wordCount" content="213">
  <meta itemprop="keywords" content="Debian,Postgresql">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Shared Memory and Swapping">
  <meta name="twitter:description" content="We have this PostgreSQL server with plenty of RAM that is still using some of its swap over the day (up to 600MB). Then suddenly everything is swapped in again.
It turned out the reason is there are two clusters running, and the second one isn’t used as heavily as the first one. Disk I/O activity of the first cluster slowly evicts pages from the second shared buffers cache to swap, and then the daily pg_dump run reads them back every evening.
I was not aware of an easy way to get numbers for “amount of SysV shared memory swapped to disk”, but some googling led to shmctl(2):
#define _GNU_SOURCE 1 #include &lt;sys/ipc.h&gt; #include &lt;sys/shm.h&gt; #include &lt;stdio.h&gt; #include &lt;unistd.h&gt; int main () { struct shm_info info; int max; long PAGE_SIZE = sysconf(_SC_PAGESIZE); max = shmctl(0, SHM_INFO, (struct shmid_ds *) &amp;info); printf (&#34;max: %d\nshm_tot: %ld\nshm_rss: %ld\nshm_swp: %ld\n&#34;, max, info.shm_tot * PAGE_SIZE, info.shm_rss * PAGE_SIZE, info.shm_swp * PAGE_SIZE); return 0; } The output looks like this:
max: 13 shm_tot: 13232308224 shm_rss: 12626661376 shm_swp: 601616384 Update: Mark points out that ipcs -mu shows the same information. Thanks for the hint!
# ipcs -mu ------ Shared Memory Status -------- segments allocated 2 pages allocated 3230544 pages resident 3177975 pages swapped 51585 Swap performance: 0 attempts 0 successes">

      
    
	
  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/blog/index.html" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Myon&#39;s Blog
      
    </a>
    <div class="flex-l items-center">
      

      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  
  <article class="flex-l mw8 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Shared Memory and Swapping</h1>
      
      <p class="tracked"><strong>Christoph Berg</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2012-11-29T10:23:10+01:00">November 29, 2012</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>We have this PostgreSQL server with plenty of RAM that is still using some of
its swap over the day (up to 600MB). Then suddenly everything is swapped in
again.</p>
<img src="http://www.df7cb.de/blog/2012/dbsrv_swap.png">
<p>It turned out the reason is there are two clusters running, and the second one
isn&rsquo;t used as heavily as the first one. Disk I/O activity of the first cluster
slowly evicts pages from the second shared buffers cache to swap, and then the
daily pg_dump run reads them back every evening.</p>
<p>I was not aware of an easy way to get numbers for &ldquo;amount of SysV shared memory
swapped to disk&rdquo;, but some googling led to shmctl(2):</p>
<pre>
#define _GNU_SOURCE 1
#include &lt;sys/ipc.h&gt;
#include &lt;sys/shm.h&gt;
#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;

int main ()
{
        struct shm_info info;
        int max;
        long PAGE_SIZE = sysconf(_SC_PAGESIZE);

        max = shmctl(0, SHM_INFO, (struct shmid_ds *) &info);
        printf ("max: %d\nshm_tot: %ld\nshm_rss: %ld\nshm_swp: %ld\n",
                        max,
                        info.shm_tot * PAGE_SIZE,
                        info.shm_rss * PAGE_SIZE,
                        info.shm_swp * PAGE_SIZE);

        return 0;
}
</pre>
<p>The output looks like this:</p>
<pre>
max: 13
shm_tot: 13232308224
shm_rss: 12626661376
shm_swp: 601616384
</pre>
<p><b>Update:</b> Mark points out that <em>ipcs -mu</em> shows the same information. Thanks for the hint!</p>
<pre>
# ipcs -mu

------ Shared Memory Status --------
segments allocated 2
pages allocated 3230544
pages resident  3177975
pages swapped   51585
Swap performance: 0 attempts     0 successes
</pre>
<ul class="pa0">
  
   <li class="list di">
     <a href="/blog/tags/debian.html" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Debian</a>
   </li>
  
   <li class="list di">
     <a href="/blog/tags/postgresql.html" class="link f5 grow br-pill ba ph3 pv2 mb2 dib black sans-serif no-underline">Postgresql</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">Related</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/blog/posts/2012/PostgreSQL_in_Debian_Hackathon.html">PostgreSQL in Debian Hackathon</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/PostgreSQL_in_Debian.html">PostgreSQL in Debian</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/grep_-r_foobar.html">grep -r foobar</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/mkfs.ext3_-b_1024.html">mkfs.ext3 -b 1024</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/Machine_Check_Exception.html">Machine Check Exception</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/Andreas.html">Andreas</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/usr_bin_time.html">Cool Unix Features: /usr/bin/time</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2012/How_not_to_edit_files.html">How not to edit files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/Generating_symbols_files_from_a_series_of_.deb_files.html">Generating symbols files from a series of .deb files</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/Tab_completion_in_vim.html">Tab completion in vim</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/Kudos_to_dh_python2.html">Kudos to dh_python2</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/dlv.html">DLV removes all *.de records</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/Marriage_and_Baptism.html">Marriage and Baptism</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/HP_2605dn_not_recognizing_new_cartridge.html">HP 2605dn not regcognizing new cartridge</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/blog/posts/2011/Heartbeat_and_bind9.html">Heartbeat and bind9</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://df7cb.de/blog/index.html" >
    &copy;  Myon's Blog 2025 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
